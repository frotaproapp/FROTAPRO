
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Verifica se Ã© Super Admin (ProprietÃ¡rio do Sistema)
    function isSuperAdmin() {
      return request.auth.token.super_admin == true;
    }

    // Helper: Verifica se pertence Ã  organizaÃ§Ã£o
    function isOrgMember(orgId) {
      return request.auth != null && request.auth.token.municipality_id == orgId;
    }

    // ðŸ”’ TENANTS (PREFEITURAS) - NÃ­vel de Edital
    // Leitura: Membros veem sua prÃ³pria org. Super Admin vÃª tudo.
    // Escrita: PROIBIDA. Somente via Cloud Functions (Admin SDK).
    match /tenants/{tenantId} {
      allow read: if isSuperAdmin() || isOrgMember(tenantId);
      allow write: if false; 
    }

    // ðŸ”’ AUDITORIA DE LICENÃ‡AS - ImutÃ¡vel
    // Leitura: Apenas Super Admin (FiscalizaÃ§Ã£o/Auditoria).
    // Escrita: PROIBIDA. Somente via Sistema Interno.
    match /license_audit/{logId} {
      allow read: if isSuperAdmin();
      allow write: if false;
    }

    // ðŸ”’ AUDITORIA GERAL DO SISTEMA - ImutÃ¡vel
    // Leitura: Apenas Super Admin.
    match /audit_logs/{logId} {
      allow read: if isSuperAdmin();
      allow write: if false;
    }

    // ðŸ”’ DADOS OPERACIONAIS
    // SÃ³ permite escrita se a licenÃ§a estiver ATIVA
    match /trips/{tripId} {
      allow read: if isOrgMember(resource.data.municipalityId);
      allow write: if isOrgMember(request.resource.data.municipalityId) && 
                     get(/databases/$(database)/documents/tenants/$(request.resource.data.municipalityId)).data.license.status == 'ACTIVE';
    }

    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isSuperAdmin());
      allow write: if false; // Gerenciado via Admin SDK / Functions
    }
  }
}