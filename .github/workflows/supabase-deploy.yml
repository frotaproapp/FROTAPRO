name: Deploy Supabase + Vercel

on:
  push:
    branches:
      - main  # ou sua branch principal

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Passo 1: Pegar o código do GitHub
      - name: Checkout repo
        uses: actions/checkout@v3

      # Passo 2: Configurar Node
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'  # ou a versão que você usa

      # Passo 3: Instalar dependências
      - name: Install dependencies
        run: npm ci

      # Passo 4: Configurar variáveis de ambiente do Supabase
      - name: Supabase login
        run: npx supabase login --token ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Link Supabase project
        run: npx supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }} --yes

      # Passo 5: Enviar migrations para Supabase
      - name: Push DB migrations
        run: npx supabase db push --yes

      # Passo 6: Build do projeto
      - name: Build project
        run: npm run build  # ou vite build

      # Passo 7: Deploy no Vercel
      - name: Deploy to Vercel
        run: npx vercel --prod --token ${{ secrets.VERCEL_TOKEN }}
